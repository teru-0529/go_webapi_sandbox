# go_webapi_sandbox
「Go言語Webアプリケーション開発」のハンズオン


## 写経元リポジトリ（参考）
https://github.com/budougumi0617/go_todo_app


## セントラルリポジトリ
https://github.com/teru-0529/go_webapi_sandbox


## 参考情報
https://qiita.com/mserizawa/items/b833e407d89abd21ee72
https://zenn.dev/msksgm/articles/20220408-go-itddd-05-repository
https://qiita.com/tjun/items/3eea798905b597ec83c0


https://tikasan.hatenablog.com/entry/2017/11/26/130000

### SECTION-053 プロジェクトの初期化

* リポジトリの作成、クローン
* VS-CODEワークスペースの保存
* Goプロジェクトの初期化

2022/09/18


### SECTION-054 Webサーバーを起動する

* 動くだけのWebサーバーを構築
  * リクエストのパスを使ってレスポンスメッセージの組み立て
  * ポート番号固定
* VS-CODEでの自動フォーマット制御
* 最終改行忘れの自動制御

```
go fmt
go run .
```


### SECTION-055 リファクタリングとテストコード

* `main`から`run`関数へ処理を分離
  * 出力結果を検証。
  * 外部からの中断操作、異常状態を検知。
* 外部からの中断操作を受け付けるため、`Shutdown`メソッドが実装されている`*http.Server`の`ListenAndServe`メソッドを利用してHTTPサーバーを起動する（`*http.Server`では、サーバーのタイムアウト時間も設定可能）
  * `*http.Server.ListenAndServe`メソッドを実行してHTTPリクエストを受け付ける。
  * 引数で渡された`context.Context`を通じて処理の中断命令を検知し、`*http.Server.Shutdown`メソッドでサーバー機能を終了する。
  * 戻り値として`*http.Server.ListenAndServe`の戻り値のエラーを返す。
* `*http.Server.ListenAndServe`メソッドを実行しつつ、`context.Context`から伝播される終了通知を待機。
  * `[golang.org/x/sync/errgroup]`パッケージを利用して終了通知を待機する。
  * `errgroup.WithContext`関数を使い取得した`*errgroup.Group`型の値の`Go`メソッドを利用することで、`func() error`というシグネチャの関数を別ゴルーチンで起動できる。
  * 別ゴルーチンでHTTPリクエストを待機しつつ、`context.Context`型の値の`Done`メソッドの戻り値として得られるチャネルからの通知を待つ。
* `run`関数のテスト
  * 期待通りにHTTPサーバーが起動しているか(HTTPサーバーの戻り値の検証)
  * 意図通りに終了するか(run関数の終了通知処理検証)

```
go test -v ./...
```


### SECTION-056 ポート番号を変更できるようにする

* 任意のポートでHTTPサーバーを起動できるようにする
  * `run`関数外部から動的に選択したポート番号のリッスンを開始した`net.Listener`インターフェースを満たす型の値を渡す。
  * `net/http`パッケージではポート番号に`0`を指定すると、利用可能なポート番号を選択してくれることを利用。
  * `main`関数では、実行時の引数でポート番号を指定する。

```
go run . %port_no%
```


### SECTION-057 Dockerを利用した実行環境

* マルチステージビルドを実施し、ビルド環境/実行環境を分割する。
* dev環境では`air`コマンドを実行しファイルの更新を検知した際に`go build`コマンドを再実行、プログラム再起動を行う。ローカルマシンのディレクトリをマウントしておくことでホットリロードを実現。
* ビルド後コンテナを起動することで、ローカルマシンからリクエストが送信できる
```
docker compose up
```


### SECTION-058 Makefileを追加する

* windwos環境のため、help(grep)/test(Buildができない？)以外を設定


### SECTION-059 Github Actionsを利用した継続的インテグレーション環境

* テストとコードカバレッジ取得の自動実行

2022/09/19


### SECTION-060 環境変数から設定をロードする

* 引数での指定を戻して、環境変数を使って起動する。
* TODO: ポート番号の動的指定をしなくなったためテストコードを一時的にスキップ


### SECTION-061 シグナルをハンドリングする

* グレースフルシャットダウンを実現する。

2022/09/20


### SECTION-062 「Server」構造体を定義する

* `http.Server`型をラップした独自定義型を作成。
* 動的に選択したポートをリッスンするため`net.Listener`型の値を引数で受け取る。
* 責務から分離するため、ルーティングの設定を引数で受け取る。


### SECTION-063 ルーティング定義を分離した「NewMux」を定義する

* どのようなハンドラーの実装をどんなURLで公開するかのルーティングを定義する`NewMux`関数を実装する。
* `*http.Server`型の値ではなく、`http.Handler`インターフェースにすることで内部実装に依存しない関数シグネチャにする。
* HTTPサーバーが稼働中かどうかを確認する`/health`エンドポイントを宣言する。


### SECTION-064 「Run」関数を再度リファクタリングする

* `Server`型、`NewMux`関数を使って`Run`関数をリファクタリングする。


### SECTION-065 「entity.Task」型の定義と永続化方法の仮実装

* TODOタスクを型として定義する。
* 永続化のための仮実装（DBを使わずMapとして保存）


### SECTION-066 ヘルパー関数を実装する

* 「レスポンスデータ」をJSONに変換しステータスコードと合わせて`http.ResponseWriter`インターフェースを満たす型の値に書き込む共通化のためのヘルパー関数を実装。
* テストで利用するJSON同士の比較関数を実装。
* テスト用のファイル読込み関数を実装。

2022/09/23


### SECTION-067 タスクを登録するエンドポイントの実装

* 「POST /tasks」へのリクエストを処理する。
  * タスクのタイトルを含んだJSONリクエストボディを必須とする。
  * 登録成功時には発行したタスクのリソースパスをLocationヘッダーにに入れて返却する。

2022/09/24


### SECTION-068 テーブルドリブンテストとゴールデンテストを組み合わせたテストコード

* 複数の入力や期待値の組み合わせを共通化した手順で実装させるパターン＝テーブルドリブンテスト
* テストの入力や期待値を別ファイルとして保存したテスト＝ゴールデンテスト


### SECTION-069 タスクを一覧するエンドポイントの実装

* タスク一覧のレスポンスを返す実装


### SECTION-070 HTTPハンドラーをルーティングに設定する

* `github.com/go-chi/chi`によるルーティング


2022/09/25

### SECTION-071 動作の検証

* Postmanからの実行
* サービス層の追加
* Get（単品検索）の追加

2022/09/26
